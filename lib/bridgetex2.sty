% \NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bridgetex2}[2022/11/18 Bridge notation]

\RequirePackage{pifont}
\RequirePackage[dvipsnames, table]{xcolor}
\RequirePackage{xspace}
\RequirePackage{bm}
\RequirePackage{multirow}
\RequirePackage{newfloat}
\RequirePackage{caption}
\RequirePackage{amsmath}
\RequirePackage[letterspace=150]{microtype}
\RequirePackage{makecell}
\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}
\RequirePackage{varwidth}
\RequirePackage{framed}
\RequirePackage[strict]{changepage}
\RequirePackage{soul}
\setstcolor{red}

\RequirePackage{array}
\newcommand{\PreserveBackslash}[1]{\let\temp=\\#1\let\\=\temp}
\newcolumntype{C}[1]{>{\PreserveBackslash\centering}p{#1}}
\newcolumntype{R}[1]{>{\PreserveBackslash\raggedleft}p{#1}}
\newcolumntype{L}[1]{>{\PreserveBackslash\raggedright}p{#1}}

\newenvironment*{dummy}{}{}

\newcommand{\clubs}{\color{OliveGreen}\ding{168}\color{black}}
\newcommand{\diams}{\color{BurntOrange}\ding{169}\color{black}}
\newcommand{\hearts}{\color{Maroon}\ding{170}\color{black}}
\newcommand{\spades}{\color{Blue}\ding{171}\color{black}}


\newcommand{\bclubs}{\color{OliveGreen}\makebox[11pt]{\ding{168}}\color{black}}
\newcommand{\bdiams}{\color{BurntOrange}\makebox[11pt]{\ding{169}}\color{black}}
\newcommand{\bhearts}{\color{Maroon}\makebox[11pt]{\ding{170}}\color{black}}
\newcommand{\bspades}{\color{Blue}\makebox[11pt]{\ding{171}}\color{black}}
\newcommand{\ntx}{{\small{NT}}}
\newcommand{\hcp}{\textsc{hcp}}
\newcommand{\gf}{\color{BrickRed}\textbf{GF}\color{black}}
\newcommand{\nf}{\color{Green}\textbf{NF}\color{black}}
\newcommand{\fonce}{\color{RedViolet}\textbf{F1}\color{black}\hspace{4pt}}
\newcommand{\inv}{\color{PineGreen}\textbf{INV}\color{black}}
\newcommand{\invp}{\color{Blue}\textbf{INV$^+$}\color{black}}
\newcommand{\slamtry}{\color{WildStrawberry}\textbf{Slam Try}\color{black}\hspace{4pt}}
\newcommand{\minor}{\color{OliveGreen}\ding{168}\hspace{-3pt}\color{BurntOrange}\ding{169}\color{black}}
\newcommand{\major}{\color{Maroon}\ding{170}\hspace{-3pt}\color{Blue}\ding{171}\color{black}}
\newcommand{\passx}{{\small{PASS}}}
\newcommand{\stopp}{\color{Maroon}\textsc{stop}\color{black}\hspace{4pt}}
\newcommand{\enemy}[1]{(#1)}
\newcommand{\dbl}{\color{Red}$\bm{\times}$\color{black}}
\newcommand{\rdbl}{\color{Blue}$\bm{\times\!\times}$\color{black}}
\newcommand{\alert}{\color{Cyan}\textsc{alert}\color{black}\hspace{4pt}}
\newcommand{\conventional}[1]{\textbf{#1*}}
\newcommand{\vul}[1]{\color{Red}\textbf{#1}\color{black}}
\newcommand{\nvul}[1]{\color{PineGreen}\textbf{#1}\color{black}}
\newcommand{\dealnr}[1]{\Large\textbf{#1}}
\newcommand{\dealer}[1]{\fbox{#1}}
\newcommand{\alrt}{\color{ProcessBlue}$^A$\color{black}}
\newcommand{\soff}{\color{CadetBlue}\textsc{sign-off}\color{black}}
\newcommand{\mixed}{\color{Fuchsia}\textbf{Mixed raise}\color{black}}
\newcommand{\ns}{\color{BurntOrange}\textbf{Non-Serious}\color{black}}
\newcommand{\lsf}{\color{WildStrawberry}\textbf{ASK LSF}\color{black}}
\newcommand{\leb}{\color{CadetBlue}\textbf{LEB}\color{black}}
\newcommand*\link[1]{\hspace*{0em plus 1fill}\makebox{#1}}
\newcommand{\imp}{\color{BurntOrange}\link{\textbf{\large!}}\color{black}}
\newcommand{\vimp}{\color{OrangeRed}\link{\textbf{\large{!!}}}\color{black}}
\newcommand{\exq}{\color{JungleGreen}\link{\textbf{\large{?!}}}\color{black}}
\newcommand{\addhcp}[1]{\color{JungleGreen}\link{\textbf{\large{#1}}}\color{black}}
\newcommand{\anysuit}[1]{\color{PineGreen}{\textbf{{#1}}}\color{black}}
\newcommand{\mins}{\textbf{m}}
\newcommand{\majs}{\textbf{\small{M}}}
\newcommand{\alrts}{\textsuperscript{\textcolor{red}{A}}}

\DeclareFloatingEnvironment[
    fileext=frm,
    placement={!ht},
    name=xd
]{xd}

\DeclareFloatingEnvironment[
    fileext=frm
    placement={!ht}
    name=Hand
]{hand}

\newcommand{\webidding}[1]{
    \begin{tabular}{cc}
        #1
    \end{tabular}
}

\newcommand{\hhand}[4]{
    {\lsstyle \bspades #1 \bhearts #2 \bdiams #3 \bclubs #4}
}

\newcommand{\chhand}[4]{
    \begin{center}
        \lsstyle \bspades #1 \bhearts #2 \bdiams #3 \bclubs #4
    \end{center}
}

\newcommand{\cihandp}[5]{
    \setlength{\fboxsep}{7pt}
    \noindent\fcolorbox{white}{white}{
        \makebox[\linewidth][s]{
            \hfill {\hhand{#1}{#2}{#3}{#4}} \hfill (#5)
        }
    }
}

\newcounter{vhand}
\newcommand{\vhand}[4]{%
    \begin{varwidth}{0.22\textwidth}
        \textls{\bspades #1 \\
        \bhearts #2 \\
        \bdiams #3 \\
        \bclubs #4 \\
    }
    \end{varwidth}%
}

\newcommand{\we}{
    \begin{varwidth}{0.20\linewidth}
        \centering
        \vspace*{-1em}
        W \qquad E
    \end{varwidth}
}

\newcommand{\qverthand}[4]{%
\begin{dummy}
    \bspades #1 \\
    \bhearts #2 \\
    \bdiams #3 \\
    \bclubs #4
\end{dummy}
}

\RequirePackage{booktabs}
\newcommand{\specialcell}[2][c]{%
    \begin{tabular}[#1]{@{}l@{}}#2\end{tabular}}

\newcommand{\br}{\vspace{0.5em}}

\definecolor{formalshade}{rgb}{0.95,0.95,1}
\definecolor{darkblue}{rgb}{0.2,0.2,0.6}
\newenvironment{formal}{%
    \def\FrameCommand{%
      \hspace{1pt}%
      {\color{darkblue}\vrule width 2pt}%
      {\color{formalshade}\vrule width 4pt}%
      \colorbox{formalshade}%
    }%
    \MakeFramed{\advance\hsize-\width\FrameRestore}%
    \noindent\hspace{-4.55pt}% disable indenting first paragraph
    \begin{adjustwidth}{}{7pt}%
    \vspace{2pt}\vspace{2pt}%
  }
  {%
    \vspace{2pt}\end{adjustwidth}\endMakeFramed%
  }

\newcommand{\allbidding}[1]{
    \begin{table}[h!]
        \centering
        \begin{tabular}{cccc}
            #1
        \end{tabular}
    \end{table}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{luacode}

\begin{luacode}
    function isBold()
    local f = font.getfont(font.current())
    if f then
        return (string.find(f.name, "bold") ~= nil)
    end
    return false
    end

    is_section_title = false

    function setSectionTitleFlag()
        is_section_title = true
    end

    function resetSectionTitleFlag()
        is_section_title = false
    end

    function isSectionTitle()
        return is_section_title
    end
\end{luacode}

\let\oldsection\section

\renewcommand{\section}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldsection{#1}
  \directlua{resetSectionTitleFlag()}%
}

\makeatletter
\let\oldsubsubsection\subsubsection

\renewcommand{\subsubsection}{%
  \@ifstar{\mysubsubsectionStar}{\mysubsubsectionNoStar}%
}

\newcommand{\mysubsubsectionNoStar}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldsubsubsection{#1}%
  \directlua{resetSectionTitleFlag()}%
}

\newcommand{\mysubsubsectionStar}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldsubsubsection*{#1}%
  \directlua{resetSectionTitleFlag()}%
}
\makeatother

\let\oldsubsection\subsection
\let\oldparagraph\paragraph

\makeatletter
\renewcommand{\subsection}{%
  \@ifstar{\mysubsectionStar}{\mysubsectionNoStar}%
}

\newcommand{\mysubsectionNoStar}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldsubsection{#1}%
  \directlua{resetSectionTitleFlag()}%
}

\newcommand{\mysubsectionStar}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldsubsection*{#1}%
  \directlua{resetSectionTitleFlag()}%
}

\renewcommand{\paragraph}{%
  \@ifstar{\myparagraphStar}{\myparagraphNoStar}%
}

\newcommand{\myparagraphNoStar}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldparagraph{#1}%
  \directlua{resetSectionTitleFlag()}%
}

\newcommand{\myparagraphStar}[1]{%
  \directlua{setSectionTitleFlag()}%
  \oldparagraph*{#1}%
  \directlua{resetSectionTitleFlag()}%
}
\makeatother

\newcommand{\nt}{%
  \directlua{%
    if isSectionTitle() then
      tex.print("{\\small{NT}}")
    else
      tex.sprint("\\textsc{nt}")
    end
  }%
}

\newcommand{\pass}{%
  \directlua{%
    if isSectionTitle() then
      tex.print("{\\small{PASS}}")
    else
      tex.sprint("\\textsc{pass}")
    end
  }%
}
